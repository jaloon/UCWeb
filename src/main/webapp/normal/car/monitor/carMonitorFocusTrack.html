<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>车辆轨迹查看</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=center-width, initial-scale=1, maximum-scale=1">
    <script src="../../../resources/plugins/jquery-1.8.3.min.js"></script>
    <script src="../../../resources/plugins/ReconnectingWebSocket/reconnecting-websocket.min.js"></script>
    <script src="../../../resources/plugins/layer/layer.js"></script>
    <script src="../../../resources/js/base.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=F0i6SrLmHquLVNLCqpExxPrj8mWVdFwx"></script>
    <style>
        .map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="map" id="bmap"></div>
</body>

</html>
<script type="text/javascript">
    $(function() {
        var map = new BMap.Map("bmap"); // 创建Map实例
        map.centerAndZoom("厦门", 12); // 初始化地图,设置中心点坐标和地图级别
        map.addControl(new BMap.NavigationControl()); //左上角，添加默认缩放平移控件
        map.addControl(new BMap.MapTypeControl()); //添加地图类型控件
        map.addControl(new BMap.ScaleControl()); // 添加比例尺
        map.addControl(new BMap.OverviewMapControl({
            isOpen: true
        })); //添加缩略地图控件
        map.enableScrollWheelZoom(); //开启鼠标滚轮缩放

        var index = parent.layer.getFrameIndex(window.name); //获取父窗口索引
        var carId = getUrlParam("carId");
        var carNumber = getUrlParam("carNumber");
        var parentSession = getUrlParam("parentSession");
        var user = decodeURIComponent(getUrlParam("user"));
        var wsUrl = getUrlParam("wsUrl");
        var ws = null;

        if ('WebSocket' in window) {
            ws = new ReconnectingWebSocket("ws://" + wsUrl + "/track");
        // } else if ('MozWebSocket' in window) {
        //     ws = new MozWebSocket("ws://" + wsUrl + "/track");
        } else {
            // ws = new SockJS("http://" + wsUrl + "/sockjs/track");
            layer.alert("您的浏览器不支持websocket协议，建议使用新版谷歌、火狐等浏览器，请勿使用IE10以下浏览器，360浏览器请使用极速模式，不要使用兼容模式！");
        }
        ws.onopen = function(event) {
            if (window.console) console.log("websocket connected");
            sendOrder();
        };
        ws.onmessage = function(event) {
            if (window.console) console.log("websocket receive message");
            var receive = event.data;
            switch (receive) {
                case "timeout": // 监控超时
                    if (window.console) console.log("monitor timeout");
                    clearInterval(timer);
                    layer.msg('单次最长只能查看1个小时！', {icon: 0}, function() {
                        parent.layer.close(index);
                    });
                    break;
                case "success": // 连接成功
                    if (window.console) console.log("request success");
                    timer = setInterval(sendRepeat, 25000);
                    break;
                case "conn_error": // 连接失败
                    if (window.console) console.log("request error");
                    reRequest('请求关注车辆数据异常，是否重新请求？', '数据异常');
                    break;
                case "conn_broken": // 连接中断
                    if (window.console) console.log("connect broken");
                    clearInterval(timer);
                    reRequest('关注车辆数据连接中断，是否重新连接？', '连接中断');
                    break;
                case "parse_error": // 服务器JSON解析异常
                    layer.msg('解析监控指令异常，请查证指令格式是否正确！', {icon: 2}, function() {
                        parent.layer.close(index);
                    });
                    break;
                case "db_error": // 服务器数据库操作异常
                    layer.msg('数据库操作异常，请联系管理员！', {icon: 2}, function() {
                        parent.layer.close(index);
                    });
                    break;
                default: // 轨迹刷新
                    reFreshPage(JSON.parse(receive));
                    break;
            }
        };
        ws.onerror = function(event) {
            if (window.console) console.log("websocket error");
        };
        ws.onclose = function(event) {
            if (window.console) console.log("websocket closed： " + event);
        };

        var points = [];
        var carMarker = null;

        function initCarIcon(alarm) {
            var carIcon;
            if (alarm == true || alarm == "true") {
                carIcon = new BMap.Icon(
                    '../../../resources/images/marker/车辆图标-32-红.png',
                    new BMap.Size(32, 15)
                );
            } else {
                carIcon = new BMap.Icon(
                    '../../../resources/images/marker/车辆图标-32-黄.png',
                    new BMap.Size(32, 15)
                );
            }
            return carIcon;
        }

        function reFreshPage(track) {
            // online: 0 离线，1 在线
            if (track.online == 0) {
                if (window.console) console.log("car offline");
                map.removeOverlay(carMarker);
                layer.msg('关注车辆离线！', {
                        icon: 5,
                        time: 1000
                    },
                    function() {
                        parent.layer.close(index);
                    }
                );
                return;
            }
            var point = new BMap.Point(track.longitude, track.latitude);
            points.push(point);
            var len = points.length;
            if (len > 1) {
                map.removeOverlay(carMarker);
            }
            if (len > 2) {
                var prePoint = points[len - 2];
                map.addOverlay(new BMap.Polyline([prePoint, point], {
                    strokeColor: "green",
                    strokeWeight: 3,
                    strokeOpacity: 0.8
                }));
            }
            var carLabel = new BMap.Label(track.carNumber + ", " + track.carStatus, {
                position: point,
                offset: new BMap.Size(-32, -18)
            });
            carLabel.setStyle({
                color: "red",
                fontSize: "10px",
                height: "16px",
                lineHeight: "16px",
                fontFamily: "微软雅黑"
            });
            carMarker = new BMap.Marker(point, {
                icon: initCarIcon(track.alarm),
                rotation: -track.angle
            });
            carMarker.setLabel(carLabel);
            map.addOverlay(carMarker);
        }

        function sendOrder() {
            var order = {
                biz: 'focus',
                bizType: 'request',
                parentSession: parseInt(parentSession, 10),
                user: user,
                carId: parseInt(carId, 10),
                carNumber: carNumber,
                token: generateUUID()
            };
            ws.send(JSON.stringify(order));
        }

        function reRequest(tip, title) {
            layer.confirm(tip, {
                    icon: 3,
                    title: [title, 'font-size:14px;color:#ffffff;background:#478de4;'],
                    btn: ['是', '否'],
                    cancel: function() {
                        //右上角关闭回调
                        parent.layer.close(index); //关闭父窗口
                    }
                },
                function(index0) {
                    //按钮【是】的回调
                    //重发监控指令
                    sendOrder();
                    layer.close(index0);
                },
                function(index0) {
                    //按钮【否】的回调
                    parent.layer.close(index); //关闭父窗口
                }
            );
        }

        function sendRepeat() {
            var order = {
                biz: 'focus',
                bizType: 'repeat',
            };
            ws.send(JSON.stringify(order));
        }

        var timer;
    });
</script>