<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=center-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>车辆实时监控</title>
    <link rel="stylesheet" href="../../../resources/css/base.css ">
    <link rel="stylesheet" href="../../../resources/css/cfgEdit.css ">
    <link rel="stylesheet" href="../../../resources/plugins/jRange/jquery.range.css">
    <script src="../../../resources/plugins/jquery-1.8.3.min.js"></script>
    <script src="../../../resources/plugins/layer/layer.js"></script>
    <script src="../../../resources/plugins/jRange/jquery.range-min.js"></script>
    <script src="../../../resources/plugins/verify.js"></script>
    <script src="../../../resources/js/base.js"></script>
</head>

<body>
<div class="container">
    <div class="info-zone">
        <div class="base-info">
            <div class="info-title">
                实时监控
            </div>
            <table class="base-table">
                <tr>
                    <td>配置范围</td>
                    <td>
                        <select class="editInfo" id="scope">
                            <option value=1>单部车辆</option>
                            <option value=2>运输公司</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>车牌号</td>
                    <td>
                        <input type="text" class="editInfo" id="carcom">
                    </td>
                </tr>
                <tr>
                    <td>轨迹上报间隔（秒）</td>
                    <td>
                        <input type="hidden" id="interval" value="30" />
                    </td>
                </tr>
                <tr>
                    <td>监控时长（分钟）</td>
                    <td>
                        <input type="hidden" id="duration" value="5" />
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="oper-zone">
        <input type="button" id="cancel" value="取消">
        <input type="button" id="confirm" value="确认">
    </div>
</div>
</body>

<script>
    $(function() {
        var comHtml = "<select class=\"editInfo\" id=\"carcom\">";
        $.ajax({
            type: "get",
            async: false, //不异步，先执行完ajax，再干别的
            url: "../../manage/transcom/getCompanyList.do",
            dataType: "json",
            success: function(response) {
                for (var i = 0, len = response.length; i < len; i++) {
                    var company = response[i];
                    comHtml += "<option value=" + company.id + ">" + company.name + "</option>";
                }
                comHtml += "</select>";
            }
        });

        $("#scope").change(function() {
            var scope = $("#scope").val();
            if (scope == 1) {
                $("#carcom").replaceWith("<input type=\"text\" class=\"editInfo\" id=\"carcom\">");
            } else {
                $("#carcom").replaceWith(comHtml);
            }
        });

        $('#interval').jRange({
            from: 1,
            to: 10,
            step: 1,
            scale: [1, 4, 7, 10],
            format: '%s',
            width: 140,
            snap: true,
            showLabels: true,
            showScale: true
        });

        $('#duration').jRange({
            from: 1,
            to: 60,
            step: 1,
            scale: [1, 20, 40, 60],
            format: '%s',
            width: 140,
            snap: true,
            showLabels: true,
            showScale: true
        });

        $("#btn_start").click(function() {
            var scope = $("#scope").val();
            var carNumber = "";
            var comId = 0;
            if (type == 1) {
                carNumber = trimAll($("#text_car").val());
                if (isNull(carNumber)) {
                    location.reload(true);
                    return;
                } else if (!isCarNo(carNumber)) {
                    layer.alert('车牌号不正确，请输入一个完整的车牌号！', { icon: 2 }, function(index2) {
                        layer.close(index2);
                        $("#text_car").select();
                    });
                    return;
                }
            } else {
                comId = $("#text_car").val();
            }
            var interval = $("#interval").val();
            var duration = $("#duration").val();
            layer.open({
                type: 2,
                title: ['车辆实时监控', 'font-size:14px;color:#ffffff;background:#478de4;'],
                shadeClose: true,
                shade: 0.6,
                area: ['800px', '560px'],
                content: '../../normal/car/carMonitorRealtime.html?' + 'car=' + encodeURI(carNumber) +
                '&comId=' + comId + '&interval=' + interval + '&duration=' + duration +
                '&parentSession=' + sessionId + '&user=' + encodeURIComponent(JSON.stringify(user)),
                end: function() {
                    var order = {
                        biz: 'realtime',
                        bizType: 'cancel',
                        session: realtimeId,
                        user: JSON.stringify(user)
                    };
                    mws.send(JSON.stringify(order));
                }
            });
        });

        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        $("#cancel").click(function() {
            parent.layer.close(index);
        });

        $("#confirm").click(function() {
            var carno = $("#carno").val();
            if (!isCarNo(carno)) {
                layer.alert('车牌号不正确，请输入一个完整的车牌号！', {
                    icon: 2
                }, function(index2) {
                    layer.close(index2);
                    $("#carno").select();
                });
                return;
            }
            var func = 0;
            var funcObjs = $(".func:checked");
            funcObjs.each(function() {
                func |= $(this).val();
            });
            var loadIndex = layer.load();
            $.post("../../../manage/remote/asyn_terminal_enable_request",
                encodeURI("car_number=" + carno + "&func_enable=" + func + "&token=" + generateUUID()),
                function(data) {
                    layer.close(loadIndex);
                    if (data.id > 0) {
                        layer.msg(data.msg, {
                            icon: 2,
                            time: 500
                        });
                    } else {
                        layer.msg('请求发送成功！', {
                            icon: 1,
                            time: 500
                        }, function() {
                            parent.layer.close(index);
                        });
                    }
                },
                "json"
            );


        });
    });
</script>