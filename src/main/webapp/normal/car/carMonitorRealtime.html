<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>车辆实时监控</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=center-width, initial-scale=1, maximum-scale=1">
    <script src="../../resources/plugins/jquery-1.8.3.min.js"></script>
    <script src="../../resources/plugins/layer/layer.js"></script>
    <script src="../../resources/js/base.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=F0i6SrLmHquLVNLCqpExxPrj8mWVdFwx"></script>
    <style>
        .map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="map" id="bmap"></div>
</body>

</html>
<script type="text/javascript">
    $(function() {
        var map = new BMap.Map("bmap"); // 创建Map实例
        map.centerAndZoom("厦门", 12); // 初始化地图,设置中心点坐标和地图级别
        map.addControl(new BMap.NavigationControl()); //左上角，添加默认缩放平移控件
        map.addControl(new BMap.MapTypeControl()); //添加地图类型控件
        map.addControl(new BMap.ScaleControl()); // 添加比例尺
        map.addControl(new BMap.OverviewMapControl({
            isOpen: true
        })); //添加缩略地图控件
        map.enableScrollWheelZoom(); //开启鼠标滚轮缩放

        var index = parent.layer.getFrameIndex(window.name); //获取父窗口索引
        var wsUrl = getUrlParam("wsUrl");
        var ws = null;
        var order = {
            biz: 'realtime',
            bizType: 'request',
            parentSession: parseInt(getUrlParam('parentSession'), 10),
            user: decodeURIComponent(getUrlParam("user")),
            car: decodeURI(getUrlParam('car')),
            comId: parseInt(getUrlParam('comId'), 10),
            // comName: decodeURI(getUrlParam('comName')),
            interval: parseInt(getUrlParam('interval'), 10),
            duration: parseInt(getUrlParam('duration'), 10)
        };
        var orderText = JSON.stringify(order);

        if ('WebSocket' in window) {
            ws = new WebSocket("ws://" + wsUrl + "/track");
        } else if ('MozWebSocket' in window) {
            ws = new MozWebSocket("ws://" + wsUrl + "/track");
        } else {
            ws = new SockJS("http://" + wsUrl + "/sockjs/track");
        }
        ws.onopen = function(event) {
            if (window.console) console.log("websocket connected");
            ws.send(orderText);
        };
        ws.onmessage = function(event) {
            if (window.console) console.log("websocket receive message");
            var receive = event.data;
            if (receive == "timeout") { // 监控超时
                if (window.console) console.log("monitor timeout");
                layer.msg('实时监控结束！', {
                        icon: 0
                    },
                    function() {
                        parent.layer.close(index);
                    }
                );
            } else if (receive == "error") { // 连接失败
                if (window.console) console.log("request error");
                layer.confirm('请求监控车辆数据异常，是否重新请求？', {
                        icon: 3,
                        title: ['数据异常', 'font-size:14px;color:#ffffff;background:#478de4;'],
                        btn: ['是', '否'],
                        cancel: function() {
                            //右上角关闭回调
                            parent.layer.close(index); //关闭父窗口
                        }
                    },
                    function(index0) {
                        //按钮【是】的回调
                        //重发监控指令
                        ws.send(orderText);
                        layer.close(index0);
                    },
                    function(index0) {
                        //按钮【否】的回调
                        parent.layer.close(index); //关闭父窗口
                    }
                );
            } else {
                var receiveObj = JSON.parse(receive);
                var biz = receiveObj.biz;
                switch (biz) {
                    case "track": // 轨迹刷新
                        reFreshPage(receiveObj);
                        break;
                    case "error": // 部分车辆连接异常
                        var tip = receiveObj.carNos + "连接异常！";
                        layer.msg(tip, {
                                icon: 0,
                                time: 1000
                            },
                            function() {
                                parent.layer.close(index);
                            }
                        );
                        break;
                    default:
                        break;
                }
            }
        };
        ws.onerror = function(event) {
            if (window.console) console.log("websocket error");
        };
        ws.onclose = function(event) {
            if (window.console) console.log("websocket closed： " + event);
        };

        var carMarker = null;

        function initCarIcon(alarm) {
            var carIcon;
            if (alarm == true || alarm == "true") {
                carIcon = new BMap.Icon(
                    '../../resources/images/marker/车辆图标-32-红.png',
                    new BMap.Size(32, 15)
                );
            } else {
                carIcon = new BMap.Icon(
                    '../../resources/images/marker/车辆图标-32-黄.png',
                    new BMap.Size(32, 15)
                );
            }
            return carIcon;
        }

        function reFreshPage(track) {
            // online: 0 离线，1 在线
            if (track.online == 0) {
                if (window.console) console.log("car offline");
                map.removeOverlay(carMarker);
                layer.msg(track.carNumber + '离线！', {
                    icon: 5,
                    time: 1000
                });
                // parent.layer.close(index);
                return;
            }
            if (!isNull(carMarker)) {
                map.removeOverlay(carMarker);
            }
            var point = new BMap.Point(track.longitude, track.latitude);
            var carLabel = new BMap.Label(track.carNumber + ", " + track.carStatus, {
                position: point,
                offset: new BMap.Size(-32, -18)
            });
            carLabel.setStyle({
                color: "red",
                fontSize: "10px",
                height: "16px",
                lineHeight: "16px",
                fontFamily: "微软雅黑"
            });
            carMarker = new BMap.Marker(point, {
                icon: initCarIcon(track.alarm),
                rotation: -track.angle
            });
            carMarker.setLabel(carLabel);
            map.addOverlay(carMarker);
        }
    });
</script>